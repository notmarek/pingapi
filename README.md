[![Website](https://img.shields.io/website?down_message=offline&label=ping.piracy.moe&up_message=online&url=https%3A%2F%2Fping.piracy.moe%2Fhealth&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH5QEaDQwpbkb66QAACLNJREFUSMc1lllzZMdxhU9W1d37djcaQDcWDgacAT2LSGpzOEIMyY/W/9R/0IueFLLDluQHk6YoSpiNM1ga6H27a1Vl6gGj/ANfxjmR5ySJ/AZgwEEs4CAOYsXZalE3kxkV88W2f7c6GmTzXrz4y81L682g2/7s8TSsFmI3KDw1CiBAwQs8gwWKEGoQgdlAKoABD/GAhbfNpl3f1H6zsLVMtxfbpuNYtxvaS6b9ZHa/Gy03anxtz/rbQrGJOGaPVtA4OAYIBAihIhCBYcAFIABDvDi3uW2K8UbaclN2F+We9cYzmLny0c1qdNIfz8uedcHKSliFl5PHe8nm5eiDsUo2Bg2BW4oJiYJnWAaRgX8ACISru3Vzu7F1NN8dF23smbyARVgEkMnuoJ8sn+6/td4Yst/efVbaTtGmw3w+PD7D2ZfsQVe/03qGWD2IAsgDAPDWLZfFrcxXw23TtZ6Y4YWYhQUCsHjn+dX0+LODq8qGPyzPWxcRuPHB9fJg/9NTM/pCeSuR5sWfVPUK4gEBi4ErpK6q+3p6u7fcHjZeO5DjB7eEmdumbsqNa3Ya1hv99bLrVUYGWjMAAeZFXi5+yA930AkNniE79le/1Zv/gwhEjF/M1rfh5P6sbDuO4UQ84AXsuanLtlxGqjrt6+FRr3eYa6OrdTm9Xd1PV5siZpMrHZUcrxb3+e6K8gsACHIc/pK3b5RfQmCml73F6rh2gQc8wExOpG0qVy7ysPrk8/3B0VFnNNBZTkHAtulrNSqrJzf3y+vl5evJtOpLlM9W0fDD98FRogcngCAZuvznev0t2ZWZTU8sNIs4gRdY7+tikZnt+YteP0jTp8eIjVtsVBrbXdluq+Rgz/QGadzLTm2aXf7Xf39YrwqOlNTkxq8oSlRnj7TRp/8uBz9BvTRZulpse16MZ2ls48rp2RGd/+SxCRSWgS9jpRveVdXfr7gTBP1MhxAuIc4r0308evr25urq6mI/IhpwW7jp+zDpQmkVxggT6ozM2elSX9ub1X5d17qdvvwsO/nXT5l8e1tHR0/EBM3931QckM38ohIpW/aUBNJYLpogz/Ju8PmZ7mW7xk7EHPnlhPszvXcEAUQgbLTdnXSXy2VRV/zyx3sHn5+qNGiuduHgU7N3AAipZ83t35Wh7JOLdnZXj8cq18mjfTvfStV2OiYWx7UPcNdwVxTb+3eAgDSRggkN/MaEfpQX3cOL3mlfCG6940psyH4+CZLUxB119kU7u3Ftm3z6Iq4f2+mdW1cEVb27jw2noaimFW+JVxIP/XrKmzkAIgUdGIiH8HBfuePMOQ/Pzd3Kb7lp72+//n9t9PCLL/df/Cg+ORfn2NrZm7e78Xj08pm0K2lqXzUCh9bDs/JXbQudDjjOabdAu/UUGrQCBmlDxugwEPZguG0RDc7zg4SblVhHRBAiHdj1dv32G25F4Ud2V2pxUXGvuIJ4EomwNbtLr86QP9Gr75QvGxcoiId4mICCkIDmehl0Y9Ik7EhHtkGU90AaTBDSYWRMqE3E1RZtHUQ6VBXBAgwCERtdBx2jeWd4pcgmpjAgBrFojTC0tzs72eo8CgYJuaq7F4YSpMMhWCACgYnibPiZIq0grfMmAcUezj2kJZhERNKe7D11uzuzuISIgniwZx1yK+10y62rbhfhQeab8XRys1OBkgIs4j2YidTo8x8fXjz3jWVhaEAcwBAGM5vMHf+b7z7xuufPfuXDPsQbPDkX64QO3XznixpQdrlVmcTHo+U7vhu3ByeXexcHwgytybMtNuX9++L2XZQZSkNIF+zBgICgdFRx1i9evYNddBNCmhucnIoVWSTN65mIMNi68vtv9X7pLl52Fn9cv7ocf9l57dugevtD+fp9+cM7Pyiix0+Sg8cm1zB9iAcAgABfTtvlh+7zF+7q99okoNRgtxTXtZPKFrUKDVvfumS6NN//YXzxJMo7fH3v9y//mqcnxc10+Z9/tlETnj+PwxSaTBaiEog8NKVzuL6Rnv5OVjCYIRCIGLbi67CZLKFVMEib8br0ZmtV5fjrv5VKbKB05W3voJXsUf3sp61Urhk+Wrl27jlTUWtCBSWsiN/dxv/z5vAXxzeD7TeWpsNnqdLKcBPbubW7Oj7dY4Jzrra6VQkZy7VjCkXHd1U4vtoAoPxUBHAyn8tf1oi+a0M6iI0PyRny03WwqqI/3+4/TWZJs+10kR4ODKPbTmcqRjzKl68nznOoYMjDxEEnEiiIfOxNAeRhCKCmlaJRQAQBCSBCAEiui72tjX59Vjn1VE6+MnZS+6pIHg1gqNnVLBIZhH6z22gB2LPzzlkrQJzmYZwSqQfOx7yEgEEAHjYAi+Cos+mYEOExxQPTjJcmtvGoV61q21gWKE05bea3K8sQZmGOQ6UUTZezIO3m/UEYJwDJw9YfY1n++ZogUP40nq4my77907qdGXKb+CjWWdpe3YkXFpDIqB9EgZQFEwE6ODvOv/gkvJvMx6vt7bzemjTNeyaM6AEDAUAQEohgGO0yOyNfZ8rK/M7E8TrYPwbQbBsWiIiwdBJzmIezXZ1mOSsTdbq9nLft4D++/IRN/3+/ffPNm2uYJEzzMEq01kQfJVKQf+lOUNWdrvEsgDdhRirrsXXNrrZtI8oQkdJ0vB++mXmTdKBMEGjn7U3ZaZfpV8/y5+ej9zeTk14zr8rJDJZiEyYmCJXSj/LixNxHkYoTxYCIGEQJBZErrK0bhdYxC0cgc9SPBnumgA7jhFxRNbyxenL5/vqbP6521crpX744/GqUfLjaXs2bebEdT+va6+eHK5tVw2FA9PG4DcIOtPZNJW0boIU4L8azCsMg7aRlrYmU8zwr1dZqtn6+2pVNWyIua68hg1SG/Ww4SHZvZ7Md75n2sBuQJ+8evCGDKAPBNQ7sDDlAsVgRUztqxZgwFAiI3m+ChkkLNJExQVPzprLOWlWtDWLP+aOROT+wIjFEhP9pPfAP0yfoPOLdWQcAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjEtMDEtMjZUMTM6MTI6NDErMDE6MDA0xJsnAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIxLTAxLTI2VDEzOjEyOjQxKzAxOjAwRZkjmwAAAFd6VFh0UmF3IHByb2ZpbGUgdHlwZSBpcHRjAAB4nOPyDAhxVigoyk/LzEnlUgADIwsuYwsTIxNLkxQDEyBEgDTDZAMjs1Qgy9jUyMTMxBzEB8uASKBKLgDqFxF08kI1lQAAAABJRU5ErkJggg==)](https://ping.piracy.moe)
[![GitHub Workflow Status](https://img.shields.io/github/workflow/status/ranimepiracy/pingapi/Docker?logo=github)](https://github.com/ranimepiracy/pingapi)
[![CodeFactor](https://www.codefactor.io/repository/github/ranimepiracy/pingapi/badge)](https://www.codefactor.io/repository/github/ranimepiracy/pingapi)
[![dependency status](https://deps.rs/repo/github/ranimepiracy/pingapi/status.svg)](https://deps.rs/repo/github/ranimepiracy/pingapi)
[![Docker Image Size (tag)](https://img.shields.io/docker/image-size/ranimepiracy/pingapi/latest?logo=docker)](https://hub.docker.com/r/ranimepiracy/pingapi)
[![Subreddit subscribers](https://img.shields.io/reddit/subreddit-subscribers/animepiracy?label=%2Fr%2Fanimepiracy&logo=reddit)](https://www.reddit.com/r/animepiracy)
[![Twitter Follow](https://img.shields.io/twitter/follow/ranimepiracy?label=%40ranimepiracy&logo=twitter&style=flat)](https://twitter.com/ranimepiracy)
[![Discord](https://img.shields.io/discord/622243127435984927?label=Discord&logo=discord)](https://discord.gg/piracy)

# Ping API

A small lightweight API, written in Rust for determining the state of remote web servers. It is developed as the Ping
API of the [/r/animepiracy index](https://github.com/ranimepiracy/index).

## Getting started

The easiest way is to use docker via:

```shell
docker run -d -p <host-port>:5000 --name=pingapi ranimepiracy/pingapi
```

You'll need to change `<host-port>` to your port of choice. The web-server is not secured via SSL/TLS, it is in your
responsibility to put a reverse proxy in front of this container.

## Parameters

Here is a table of the possible ENV-variables with their default values.

| Parameter | Function |
| :----: | --- |
| `-e INTERVAL=300` | Time in s of when a known ping status is considered outdated and automatically refreshed |
| `-e TIMEOUT=10` | Timeout for ping requests |
| `-e CORS="https://piracy.moe"` | Regex of URLs which uses this ping-api |
| `-e RUST_LOG="info"` | Possible log-levels: `error`, `warn`, `info`, `debug` or `trace` |
| `-e SOCKS_IP=""` | IP:PORT of the SOCKS server for ping requests |
| `-e SOCKS_USER=""` | Username for SOCKS server for ping requests |
| `-e SOCKS_PASS=""` | Password for SOCKS server for ping requests |

Every 2 * `TIMEOUT` the background process will go through the list of known URLs to keep watch of and checks if their
age is older than `INTERVAL` and if needed, updates the status with a new ping.

By default Ping API only allows requests from `http://localhost:8080` and `https://piracy.moe`. You can overwrite `CORS`
with a single URL, if you only want to match against it or use any [valid regex string](https://regexr.com/) for
matching.

## API

Ping API supports only the following HTTP requests:

- `GET` `/` will make a redirect to the URL provided by the env `CORS`

- `GET` `/health` returns `200` `OK`

- `POST` `/ping` returns a json-object of the following form:
  ```json
  {
  "url": "https://piracy.moe",
  "time": "1616615820",
  "status": "up"
  }
  ```
    - `url` is the URL against which the ping has been tested
    - `time` is the unix epoch timestamp in seconds
    - `status` can be either `up`, `down` or `unknown`

  It requires a json-object in the request body and `Content-Type` to be `application/json`. The body should be of the
  form:
  ```json
  {
    "url": "https://piracy.moe"
  }
  ```

- `POST` `/pings` returns a json-array of objects, which are of the same form as in `/ping`:
  ```json
  [{
    "url": "https://piracy.moe",
    "time": "1616615820",
    "status": "up"
  },
  ...,
  {
    "url": "https://example.com",
    "time": "1616615816",
    "status": "up"
  }]
  ```

  It requires a json-array of urls in the request body and `Content-Type` to be `application/json`. The body should be
  of the form:
    ```json
    {
      "urls": [
        "https://piracy.moe",
        "https://example.com"
      ]
    }
    ```

***Note:** when you request a URL for the first time, it will always return an object like this:*

```json
{
  "url": "https://piracy.moe",
  "time": "0",
  "status": "unknown"
}
```

The background process will process it automatically and then update the values.

## Updating container image

To get the newest version of image from [docker-hub](https://hub.docker.com/repository/docker/ranimepiracy/pingapi), you
will need to run:

```shell
docker pull ranimepiracy/pingapi
```

Afterwards you will need to stop and remove your current running instance and start it again.

## Building from source

To build the [docker image](https://docs.docker.com/engine/reference/commandline/build/) you will need to run:

```shell
docker build . -t pingapi
```

Afterwards you will just need to run

```shell
docker run -d -p <host-port>:5000 pingapi
```

You can than open http://localhost:5000 in your browser.

## Contribution

Pull-requests are always welcome, but may not be always merged as it has to be in align with our idea of the index. If
you want a certain feature or have an idea, you can always open a feature request
in [Issues](https://github.com/ranimepiracy/pingapi/issues/)
or report it on our [Discord](https://discord.gg/piracy) in `#index-wiki` to be discussed. If it is not bad, in align with
our ideas, and we find some time, we will certainly implement your requested feature (sometime...).

## What we use

to build this API:

- [Actix](https://actix.rs/)
- [actix-socks](https://github.com/ranimepiracy/actix-socks)
- [redis](https://redis.io/)
